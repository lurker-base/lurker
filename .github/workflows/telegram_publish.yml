name: Publish LURKER Signal to Telegram

on:
  workflow_dispatch:
    inputs:
      signal_file:
        description: 'Path to signal JSON file'
        required: true
        default: 'signals/latest.json'
  push:
    paths:
      - "signals/latest.json"

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate signal (anti-doublon + rarity gate)
        id: validate
        run: |
          python3 scripts/validate_signal.py signals/latest.json
          if [ $? -ne 0 ]; then
            echo "status=REJECTED" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "status=VALIDATED" >> $GITHUB_OUTPUT

      - name: Skip if rejected
        if: steps.validate.outputs.status == 'REJECTED'
        run: |
          echo "Signal rejected by validator â€” stopping."
          exit 0

      - name: Extract signal message
        if: steps.validate.outputs.status == 'VALIDATED'
        id: msg
        run: |
          TEXT=$(python3 - << 'PY'
          import json
          with open("signals/latest.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          msg = data.get("message", "ðŸ”” LURKER: New signal")
          print(msg)
          PY)
          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Telegram (with proof)
        if: steps.validate.outputs.status == 'VALIDATED'
        run: |
          set -euo pipefail
          echo "Sending to chat_id=${TELEGRAM_CHAT_ID}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true" \
            -d "parse_mode=HTML" | tee telegram_response.json
          python3 - << 'PY'
          import json, sys
          j = json.load(open("telegram_response.json", "r", encoding="utf-8"))
          if not j.get("ok"):
              print("Telegram API returned ok=false:", j, file=sys.stderr)
              sys.exit(1)
          print("âœ… Telegram OK. message_id =", j["result"]["message_id"])
          PY
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TEXT: ${{ steps.msg.outputs.text }}

      - name: Commit updated state files
        if: steps.validate.outputs.status == 'VALIDATED'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state/posted.json state/daily_count.json signals/latest.json
          git diff --cached --quiet || git commit -m "chore: update signal state [skip ci]"
          git push
